<!DOCTYPE html>
<html lang="ar" >
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ùˆ USS - Ø¯. Ø£Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px auto;
      max-width: 700px;
      background: #f5f5f5;
      color: #222;
      direction: rtl;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    nav {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    nav button {
      padding: 10px 15px;
      border: none;
      background: #ddd;
      cursor: pointer;
      border-radius: 5px;
      font-weight: bold;
    }
    nav button.active {
      background: #4caf50;
      color: white;
    }
    section {
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
    }
    label {
      display: block;
      margin: 10px 0 5px 0;
    }
    select, textarea, input[type="text"], button {
      width: 100%;
      padding: 8px;
      font-size: 1em;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      margin-bottom: 15px;
    }
    button.primary {
      background: #4caf50;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button.primary:hover {
      background: #45a049;
    }
    #status, #ussStatus {
      min-height: 30px;
      padding: 10px;
      border-radius: 5px;
      font-weight: bold;
      margin-bottom: 10px;
      display: none;
    }
    #status.info, #ussStatus.info {
      background-color: #e3f2fd;
      color: #1e88e5;
    }
    #status.success, #ussStatus.success {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    #status.error, #ussStatus.error {
      background-color: #fdecea;
      color: #e74c3c;
    }
    #status.warning, #ussStatus.warning {
      background-color: #fffde7;
      color: #fdd835;
    }
    pre {
      background: #eee;
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
      border-radius: 5px;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>

  <h2>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² ÙˆØ¨ÙŠØ§Ù†Ø§Øª USS - Ø¯. Ø£Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯</h2>

  <nav>
    <button id="tabLinksBtn" class="active">Ø±ÙØ¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²</button>
    <button id="tabUSSBtn">ÙØ­Øµ ÙˆØªØ­Ù…ÙŠÙ„ USS</button>
  </nav>

  <!-- ØªØ¨ÙˆÙŠØ¨ Ø±ÙØ¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² -->
  <section id="tabLinks" style="display:block;">
    <label for="linkType">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø±Ø§Ø¨Ø·:</label>
    <select id="linkType">
      <option value="Super Fertilizer">Ø³Ù…Ø§Ø¯ Ø®Ø§Ø±Ù‚</option>
      <option value="Super Watering Can">Ø¯Ù„Ùˆ Ø³Ù‚Ø§ÙŠØ© Ø®Ø§Ø±Ù‚</option>
      <option value="Bingo">Ø¨ÙŠÙ†Ø¬Ùˆ</option>
      <option value="normalfert">125 Ø³Ù…Ø§Ø¯ Ø·Ø¨ÙŠØ¹ÙŠ</option>
      <option value="Energy">Ø·Ø§Ù‚Ø©</option>
      <option value="Other">Ø£Ø®Ø±Ù‰ (Ø¹Ø§Ù…)</option>
    </select>

    <label for="linksInput">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· (ÙƒÙ„ Ø±Ø§Ø¨Ø· ÙÙŠ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯):</label>
    <textarea id="linksInput" placeholder="https://example.com/link1
https://example.com/link2"></textarea>

    <button id="uploadBtn" class="primary">ğŸš€ Ø±ÙØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</button>

    <div id="status" class="info"></div>
  </section>

  <!-- ØªØ¨ÙˆÙŠØ¨ ÙØ­Øµ ÙˆØªØ­Ù…ÙŠÙ„ USS -->
  <section id="tabUSS" style="display:none;">
    <button id="checkDuplicatesBtn" class="primary">ğŸ” ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±</button>
    <button id="downloadUniqueBtn" class="primary" style="margin-top:5px;">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±</button>

    <div id="ussStatus" class="info"></div>
    <pre id="ussReport" style="display:none;"></pre>
  </section>

  <script>
    // Ø¥Ø¹Ø¯Ø§Ø¯ Supabase
    const SUPABASE_URL = 'https://wuauxagghhzqrxgotcqo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1YXV4YWdnaGh6cXJ4Z290Y3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0NjU3NzYsImV4cCI6MjA2ODA0MTc3Nn0.W7Ayyfdh3qmrfzw_F5t35umQZRIdmqKENNdk3HYcNVE';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    const tabLinksBtn = document.getElementById('tabLinksBtn');
    const tabUSSBtn = document.getElementById('tabUSSBtn');
    const tabLinks = document.getElementById('tabLinks');
    const tabUSS = document.getElementById('tabUSS');

    tabLinksBtn.onclick = () => {
      tabLinks.style.display = 'block';
      tabUSS.style.display = 'none';
      tabLinksBtn.classList.add('active');
      tabUSSBtn.classList.remove('active');
      clearStatus();
    };
    tabUSSBtn.onclick = () => {
      tabLinks.style.display = 'none';
      tabUSS.style.display = 'block';
      tabUSSBtn.classList.add('active');
      tabLinksBtn.classList.remove('active');
      clearUSSStatus();
    };

    // ÙˆØ¸Ø§Ø¦Ù Ø±ÙØ¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²
    const uploadBtn = document.getElementById('uploadBtn');
    const statusDiv = document.getElementById('status');

    function showStatus(message, type = 'info') {
      statusDiv.style.display = 'block';
      statusDiv.textContent = message;
      statusDiv.className = type;
    }
    function clearStatus() {
      statusDiv.style.display = 'none';
      statusDiv.textContent = '';
    }

    uploadBtn.addEventListener('click', async () => {
      clearStatus();
      showStatus('â³ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·...', 'info');
      const type = document.getElementById('linkType').value;
      const rawLinks = document.getElementById('linksInput').value.trim();

      if (!rawLinks) {
        showStatus('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±ÙˆØ§Ø¨Ø· ØµØ­ÙŠØ­Ø©.', 'warning');
        return;
      }

      const links = rawLinks.split('\n').map(l => l.trim()).filter(l => l.length > 0);

      let successCount = 0;

      for (const link of links) {
        try {
          const { error } = await supabase
            .from('reward_links')
            .insert([{ link_url: link, link_type: type, status: 'new' }]);

          if (!error) {
            successCount++;
          } else {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„:', error);
          }
        } catch (e) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', e);
        }
      }

      showStatus(`âœ… ØªÙ… Ø±ÙØ¹ ${successCount} Ø±Ø§Ø¨Ø· Ù…Ù† Ø£ØµÙ„ ${links.length}.`, 'success');
    });

    // ÙˆØ¸Ø§Ø¦Ù ÙØ­Øµ ÙˆØªØ­Ù…ÙŠÙ„ USS
    const checkDuplicatesBtn = document.getElementById('checkDuplicatesBtn');
    const downloadUniqueBtn = document.getElementById('downloadUniqueBtn');
    const ussStatus = document.getElementById('ussStatus');
    const ussReport = document.getElementById('ussReport');

    function showUSSStatus(message, type = 'info') {
      ussStatus.style.display = 'block';
      ussStatus.textContent = message;
      ussStatus.className = type;
    }
    function clearUSSStatus() {
      ussStatus.style.display = 'none';
      ussStatus.textContent = '';
      ussReport.style.display = 'none';
      ussReport.textContent = '';
    }

    async function fetchAllCheckRequests() {
      let allData = [];
      let from = 0;
      const batchSize = 1000;

      while (true) {
        const { data, error } = await supabase
          .from('check_requests')
          .select('*')
          .range(from, from + batchSize -1);

        if (error) {
          console.error('Ø®Ø·Ø£ Supabase:', error);
          showUSSStatus('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', 'error');
          return null;
        }
        if (!data || data.length === 0) break;

        allData = allData.concat(data);
        if (data.length < batchSize) break;

        from += batchSize;
      }
      return allData;
    }

    checkDuplicatesBtn.onclick = async () => {
      clearUSSStatus();
      showUSSStatus('... Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ...', 'info');
      const data = await fetchAllCheckRequests();
      if (!data) {
        showUSSStatus('âŒ Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', 'error');
        return;
      }

      const totalRecords = data.length;
      const countMap = {};
      data.forEach(row => {
        if (!countMap[row.uss]) {
          countMap[row.uss] = { count: 0, names: new Set(), firstHash: row.hash };
        }
        countMap[row.uss].count++;
        if(row.name) countMap[row.uss].names.add(row.name);
      });

      const uniqueCount = Object.keys(countMap).length;
      const totalRepeats = totalRecords - uniqueCount;

      if (totalRepeats === 0) {
        showUSSStatus('âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙƒØ±Ø§Ø±.', 'success');
        ussReport.style.display = 'none';
        return;
      }

      let msg = `ğŸ” Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙƒÙ„ÙŠ: ${totalRecords}\n`;
      msg += `ğŸ” Ø¹Ø¯Ø¯ Ø§Ù„Ù€ uss Ø§Ù„ÙØ±ÙŠØ¯Ø©: ${uniqueCount}\n`;
      msg += `ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ©: ${totalRepeats}\n\n`;

      // Ø¹Ø±Ø¶ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ù…Ø«Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªÙƒØ±Ø§Ø±
      const repeatedUSS = Object.entries(countMap)
        .filter(([uss, info]) => info.count > 1)
        .slice(0, 10);

      if (repeatedUSS.length > 0) {
        msg += 'Ø£Ù…Ø«Ù„Ø© Ø¹Ù„Ù‰ USS Ø§Ù„Ù…ÙƒØ±Ø±Ø©:\n';
        repeatedUSS.forEach(([uss, info]) => {
          const names = Array.from(info.names).join(', ');
          msg += `- uss: ${uss} (Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±: ${info.count})${names ? ' - Ø£Ø³Ù…Ø§Ø¡: ' + names : ''}\n`;
        });
      }

      ussReport.style.display = 'block';
      ussReport.textContent = msg;
      showUSSStatus('âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙƒØ±Ø§Ø±Ø§Øª.', 'warning');
    };

    downloadUniqueBtn.onclick = async () => {
      clearUSSStatus();
      showUSSStatus('â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ù„Ù...', 'info');

      const data = await fetchAllCheckRequests();
      if (!data) {
        showUSSStatus('âŒ Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', 'error');
        return;
      }

      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ussØŒ Ù†Ø£Ø®Ø° Ø£ÙˆÙ„ Ø¸Ù‡ÙˆØ± ÙÙ‚Ø·
      const uniqueMap = new Map();
      data.forEach(row => {
        if (!uniqueMap.has(row.uss)) {
          uniqueMap.set(row.uss, row);
        }
      });

      // ØªØ¬Ù‡ÙŠØ² Ù†Øµ Ø§Ù„Ù…Ù„Ù
      let fileContent = 'uss,hash\n';
      uniqueMap.forEach(row => {
        fileContent += `${row.uss},${row.hash}\n`;
      });

      // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ ÙˆØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
      const blob = new Blob([fileContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'unique_uss_hash.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showUSSStatus(`âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª (${uniqueMap.size} Ø³Ø¬Ù„).`, 'success');
    };

  </script>
</body>
</html>
