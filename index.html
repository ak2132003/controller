<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8" />
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² ÙˆÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±</title>
    <script src="https://unpkg.com/@supabase/supabase-js/dist/supabase.min.js"></script>
    <style>
        body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background: #f9f9f9; padding: 20px; }
        .tabs { display: flex; margin-bottom: 10px; }
        .tab-button { padding: 10px 20px; border: none; cursor: pointer; background: #ddd; margin-right: 5px; border-radius: 5px 5px 0 0; }
        .tab-button.active { background: #4caf50; color: white; }
        .panel { background: white; border: 1px solid #ccc; padding: 15px; border-radius: 0 5px 5px 5px; max-width: 600px; margin-bottom: 20px; }
        button { cursor: pointer; margin-top: 10px; }
        textarea { width: 100%; height: 100px; resize: vertical; }
        select, input[type=file] { width: 100%; margin-top: 5px; }
        #status { margin-top: 10px; padding: 10px; border-radius: 5px; display: none; }
    </style>
</head>
<body>

    <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² ÙˆÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±</h1>

    <div class="tabs">
        <button class="tab-button active" data-tab="uploadPanel">Ø±ÙØ¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²</button>
        <button class="tab-button" data-tab="checkPanel">ÙØ­Øµ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø±</button>
    </div>

    <div id="uploadPanel" class="panel">
        <!-- ÙˆØ§Ø¬Ù‡Ø© Ø±ÙØ¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² (Ù…Ù‚ØªØ¨Ø³Ø© ÙˆÙ…Ø¹Ø¯Ù„Ø© Ù…Ù† Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø£ÙˆÙ„) -->
        <label>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø±Ø§Ø¨Ø·:</label>
        <select id="linkTypeSelect"></select>
        <input type="file" id="fileInput" accept=".txt" />
        <textarea id="manualLinks" placeholder="ÙŠÙ…ÙƒÙ†Ùƒ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù‡Ù†Ø§ØŒ ÙƒÙ„ Ø±Ø§Ø¨Ø· ÙÙŠ Ø³Ø·Ø±"></textarea>
        <button id="uploadButton" style="background:#4caf50; color:white;">ğŸš€ Ø±ÙØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</button>
        <button id="deleteButton" style="background:#FF5733; color:white;">ğŸ—‘ï¸ Ø­Ø°Ù Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
        <button id="deleteAllButton" style="background:#FF4500; color:white;">ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</button>
        <button id="countButton" style="background:#2196F3; color:white;">ğŸ“Š Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ ÙƒÙ„ Ù†ÙˆØ¹</button>

        <div id="uploadCounter" style="margin-top: 10px;">
            <strong>Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©: </strong><span id="currentUploadCount">0</span> / <span id="totalLinksCount">0</span>
        </div>
        <div id="uploadStatus" style="margin-top: 15px;"></div>
    </div>

    <div id="checkPanel" class="panel" style="display:none;">
        <!-- ÙˆØ§Ø¬Ù‡Ø© ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù (Ù…Ù‚ØªØ¨Ø³Ø© ÙˆÙ…Ø¹Ø¯Ù„Ø© Ù…Ù† Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø«Ø§Ù†ÙŠ) -->
        <button id="checkDuplicates" style="background:#FF9800; color:white;">ğŸ” ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±</button>
        <button id="downloadUnique" style="background:#4caf50; color:white;">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±</button>
        <pre id="checkStatus" style="background:#eee; padding:10px; height:250px; overflow:auto;"></pre>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯ Supabase
        const SUPABASE_URL = 'https://wuauxagghhzqrxgotcqo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1YXV4YWdnaGh6cXJ4Z290Y3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0NjU3NzYsImV4cCI6MjA2ODA0MTc3Nn0.W7Ayyfdh3qmrfzw_F5t35umQZRIdmqKENNdk3HYcNVE';

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ØªØ¹Ø±ÙŠÙ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· (ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø£ÙˆÙ„)
        const linkTypes = {
            'Super Fertilizer': 'Ø³Ù…Ø§Ø¯ Ø®Ø§Ø±Ù‚',
            'Super Watering Can': 'Ø¯Ù„Ùˆ Ø³Ù‚Ø§ÙŠØ© Ø®Ø§Ø±Ù‚',
            'Bingo': 'Ø¨ÙŠÙ†Ø¬Ùˆ',
            'normalfert': '125 Ø³Ù…Ø§Ø¯ Ø·Ø¨ÙŠØ¹ÙŠ',
            'Energy': 'Ø·Ø§Ù‚Ø©',
            'Energy2': '2Ø·Ø§Ù‚Ø©',
            'Yellow Package': 'Ø­Ø²Ù…Ø© ØµÙØ±Ø§Ø¡',
            'Green Package': 'Ø­Ø²Ù…Ø© Ø®Ø¶Ø±Ø§Ø¡',
            'Yellow Coupons': 'Ù‚Ø³Ø§Ø¦Ù… ØµÙØ±Ø§Ø¡',
            'Purple Coupons': 'Ù‚Ø³Ø§Ø¦Ù… Ø£Ø±Ø¬ÙˆØ§Ù†ÙŠØ©',
            'Green Coupons': 'Ù‚Ø³Ø§Ø¦Ù… Ø®Ø¶Ø±Ø§Ø¡',
            'Other': 'Ø£Ø®Ø±Ù‰ (Ø¹Ø§Ù…)'
        };

        // Ù…Ù„Ø¦ select Ø¨Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
        const linkTypeSelect = document.getElementById('linkTypeSelect');
        for (const [key, value] of Object.entries(linkTypes)) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = value;
            linkTypeSelect.appendChild(option);
        }

        // Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        const tabs = document.querySelectorAll('.tab-button');
        tabs.forEach(tab => {
            tab.onclick = () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('uploadPanel').style.display = tab.dataset.tab === 'uploadPanel' ? 'block' : 'none';
                document.getElementById('checkPanel').style.display = tab.dataset.tab === 'checkPanel' ? 'block' : 'none';
            };
        });

        // Ø±ÙØ¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²
        const fileInput = document.getElementById('fileInput');
        const manualLinks = document.getElementById('manualLinks');
        const uploadButton = document.getElementById('uploadButton');
        const deleteButton = document.getElementById('deleteButton');
        const deleteAllButton = document.getElementById('deleteAllButton');
        const countButton = document.getElementById('countButton');
        const uploadStatus = document.getElementById('uploadStatus');
        const currentUploadCountElem = document.getElementById('currentUploadCount');
        const totalLinksCountElem = document.getElementById('totalLinksCount');

        let currentUploadCount = 0;
        let totalLinksCount = 0;

        function updateUploadStatus(message, type = 'info') {
            uploadStatus.style.display = 'block';
            uploadStatus.textContent = message;
            const colors = {
                success: '#2E7D32',
                error: '#e74c3c',
                warning: '#FDD835',
                info: '#1e88e5',
            };
            uploadStatus.style.color = colors[type] || colors.info;
        }

        async function uploadLinks() {
            const file = fileInput.files[0];
            const manualInput = manualLinks.value.trim();
            const selectedLinkType = linkTypeSelect.value;

            if (!file && manualInput === '') {
                updateUploadStatus('âŒ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙŠØ¯ÙˆÙŠÙ‹Ø§!', 'error');
                return;
            }

            let links = [];

            if (file) {
                const text = await file.text();
                links = links.concat(text.split('\n').map(l => l.trim()));
            }
            if (manualInput) {
                links = links.concat(manualInput.split('\n').map(l => l.trim()));
            }

            // ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· (ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø³ÙƒØ±Ø¨Øª)
            const validLinks = links.filter(link => link.startsWith('https://apps.facebook.com/family-farm/ar/facebook'));
            const invalidLinksCount = links.length - validLinks.length;

            if (validLinks.length === 0) {
                updateUploadStatus('âš ï¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­Ø©! ÙŠØ¬Ø¨ Ø£Ù† ØªØ¨Ø¯Ø£ Ø¨Ù€ https://apps.facebook.com/family-farm/ar/facebook', 'warning');
                return;
            }

            totalLinksCount = validLinks.length;
            totalLinksCountElem.textContent = totalLinksCount;
            currentUploadCount = 0;
            currentUploadCountElem.textContent = currentUploadCount;
            updateUploadStatus('â³ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·...', 'info');

            for (const link of validLinks) {
                const cleanedLink = link.replace(/^\d+\.\s*/, '').trim();
                const { error } = await supabase
                    .from('reward_links')
                    .insert([{ link_url: cleanedLink, status: 'new', link_type: selectedLinkType }]);
                if (!error) {
                    currentUploadCount++;
                    currentUploadCountElem.textContent = currentUploadCount;
                }
            }

            let msg = `âœ… ØªÙ… Ø±ÙØ¹ ${currentUploadCount} Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!`;
            if (invalidLinksCount > 0) {
                msg += ` âŒ ØªÙ… ØªØ¬Ø§Ù‡Ù„ ${invalidLinksCount} Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­.`;
            }
            updateUploadStatus(msg, 'success');
        }

        async function deleteLinksByType() {
            const selectedLinkType = linkTypeSelect.value;
            const { error } = await supabase.from('reward_links').delete().eq('link_type', selectedLinkType);
            if (error) {
                updateUploadStatus('âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø±ÙˆØ§Ø¨Ø·!', 'error');
                return;
            }
            updateUploadStatus(`âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù†ÙˆØ¹: ${linkTypes[selectedLinkType]}`, 'success');
        }

        async function deleteAllLinks() {
            const { error } = await supabase.from('reward_links').delete();
            if (error) {
                updateUploadStatus('âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·!', 'error');
                return;
            }
            updateUploadStatus('âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        }

        async function countLinkTypes() {
            updateUploadStatus('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ ÙƒÙ„ Ù†ÙˆØ¹...', 'info');

            let total = 0;
            let output = '';
            for (const [enType, arLabel] of Object.entries(linkTypes)) {
                const { count, error } = await supabase
                    .from('reward_links')
                    .select('*', { count: 'exact', head: true })
                    .eq('link_type', enType);
                if (error) {
                    output += `${arLabel}: Ø®Ø·Ø£\n`;
                } else {
                    total += count;
                    output += `${arLabel}: ${count}\n`;
                }
            }
            updateUploadStatus(`ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù„ÙƒÙ„ Ù†ÙˆØ¹:\n${output}Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·: ${total}`, 'info');
        }

        uploadButton.addEventListener('click', uploadLinks);
        deleteButton.addEventListener('click', deleteLinksByType);
        deleteAllButton.addEventListener('click', deleteAllLinks);
        countButton.addEventListener('click', countLinkTypes);

        // --- ØªØ¨ÙˆÙŠØ¨ ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø± ---

        const checkStatus = document.getElementById('checkStatus');
        const checkDuplicatesBtn = document.getElementById('checkDuplicates');
        const downloadUniqueBtn = document.getElementById('downloadUnique');

        async function fetchAllCheckRequests() {
            let allData = [];
            let from = 0;
            const batchSize = 1000;
            while (true) {
                const { data, error } = await supabase
                    .from('check_requests')
                    .select('*')
                    .range(from, from + batchSize - 1);
                if (error) {
                    alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
                    return null;
                }
                if (!data || data.length === 0) break;
                allData = allData.concat(data);
                if (data.length < batchSize) break;
                from += batchSize;
            }
            return allData;
        }

        checkDuplicatesBtn.onclick = async () => {
            checkStatus.textContent = '... Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ...';
            const data = await fetchAllCheckRequests();
            if (!data) {
                checkStatus.textContent = 'âŒ Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.';
                return;
            }
            const totalRecords = data.length;
            const countMap = {};
            data.forEach(row => {
                if (!countMap[row.uss]) {
                    countMap[row.uss] = { count: 0, names: new Set(), firstHash: row.hash };
                }
                countMap[row.uss].count++;
                countMap[row.uss].names.add(row.name);
            });
            const uniqueCount = Object.keys(countMap).length;
            const totalRepeats = totalRecords - uniqueCount;

            if (totalRepeats === 0) {
                checkStatus.textContent = 'âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙƒØ±Ø§Ø±.';
                return;
            }

            let msg = `ğŸ” Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙƒÙ„ÙŠ: ${totalRecords}\n`;
            msg += `ğŸ” Ø¹Ø¯Ø¯ Ø§Ù„Ù€ uss Ø§Ù„ÙØ±ÙŠØ¯Ø©: ${uniqueCount}\n`;
            msg += `ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ©: ${totalRepeats}\n\n`;
            for (const uss in countMap) {
                const info = countMap[uss];
                if (info.count > 1) {
                    msg += `- ${[...info.names].join(', ')} â€” Ù…ÙƒØ±Ø± ${info.count} Ù…Ø±Ø§Øª\n`;
                }
            }
            checkStatus.textContent = msg;
        };

        downloadUniqueBtn.onclick = async () => {
            const data = await fetchAllCheckRequests();
            if (!data) return;

            const seen = new Set();
            const lines = [];
            for (const row of data) {
                if (!seen.has(row.uss)) {
                    seen.add(row.uss);
                    lines.push(`${row.uss},${row.hash}`);
                }
            }

            const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'unique_requests.txt';
            a.click();
            URL.revokeObjectURL(url);
        };
    </script>

</body>
</html>
