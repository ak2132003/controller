<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² - Ø¯. Ø£Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯</title>
<style>
    body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f8fa;
        margin: 0; padding: 20px;
        color: #333;
    }
    h1, h2 {
        color: #2e7d32;
        text-align: center;
    }
    .container {
        max-width: 800px;
        margin: auto;
        background: #fff;
        padding: 25px 30px;
        border-radius: 12px;
        box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }
    label {
        display: block;
        margin: 15px 0 6px 0;
        font-weight: bold;
    }
    select, textarea, input[type="file"] {
        width: 100%;
        padding: 10px;
        font-size: 1rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
        font-family: inherit;
        resize: vertical;
    }
    textarea {
        min-height: 90px;
    }
    button {
        background-color: #4caf50;
        border: none;
        color: white;
        padding: 12px 20px;
        margin: 10px 5px 0 0;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
        user-select: none;
    }
    button:hover:not(:disabled) {
        background-color: #388e3c;
    }
    button:disabled {
        background-color: #a5d6a7;
        cursor: not-allowed;
    }
    .btn-danger {
        background-color: #e53935;
    }
    .btn-danger:hover:not(:disabled) {
        background-color: #b71c1c;
    }
    .btn-info {
        background-color: #1976d2;
    }
    .btn-info:hover:not(:disabled) {
        background-color: #0d47a1;
    }
    #status, #dupStatus {
        margin-top: 15px;
        padding: 12px;
        border-radius: 8px;
        font-size: 0.95rem;
        min-height: 40px;
        white-space: pre-wrap;
        background-color: #e3f2fd;
        color: #1565c0;
        user-select: text;
    }
    .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 2px solid #ccc;
        justify-content: center;
        gap: 20px;
        cursor: pointer;
    }
    .tab {
        padding: 10px 18px;
        font-weight: bold;
        border-radius: 8px 8px 0 0;
        background: #e0e0e0;
        user-select: none;
    }
    .tab.active {
        background: #4caf50;
        color: white;
        border-bottom: 2px solid white;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    /* Scroll area for status with max height */
    #status, #dupStatus {
        max-height: 160px;
        overflow-y: auto;
    }
</style>
</head>
<body>

<div class="container">
    <h1>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²</h1>

    <div class="tabs">
        <div id="tabLinks" class="tab active">Ø±ÙØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ­Ø°ÙÙ‡Ø§</div>
        <div id="tabDuplicates" class="tab">ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙˆØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</div>
    </div>

    <!-- ØªØ¨ÙˆÙŠØ¨ Ø±ÙØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· -->
    <section id="linksTab" class="tab-content active">
        <label for="linkTypeSelect">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø±Ø§Ø¨Ø·:</label>
        <select id="linkTypeSelect" aria-label="Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø±Ø§Ø¨Ø·">
            <option value="Super Fertilizer">Ø³Ù…Ø§Ø¯ Ø®Ø§Ø±Ù‚</option>
            <option value="Super Watering Can">Ø¯Ù„Ùˆ Ø³Ù‚Ø§ÙŠØ© Ø®Ø§Ø±Ù‚</option>
            <option value="Bingo">Ø¨ÙŠÙ†Ø¬Ùˆ</option>
            <option value="normalfert">125 Ø³Ù…Ø§Ø¯ Ø·Ø¨ÙŠØ¹ÙŠ</option>
            <option value="Energy">Ø·Ø§Ù‚Ø©</option>
            <option value="Energy2">2 Ø·Ø§Ù‚Ø©</option>
            <option value="Yellow Package">Ø­Ø²Ù…Ø© ØµÙØ±Ø§Ø¡</option>
            <option value="Green Package">Ø­Ø²Ù…Ø© Ø®Ø¶Ø±Ø§Ø¡</option>
            <option value="Yellow Coupons">Ù‚Ø³Ø§Ø¦Ù… ØµÙØ±Ø§Ø¡</option>
            <option value="Purple Coupons">Ù‚Ø³Ø§Ø¦Ù… Ø£Ø±Ø¬ÙˆØ§Ù†ÙŠØ©</option>
            <option value="Green Coupons">Ù‚Ø³Ø§Ø¦Ù… Ø®Ø¶Ø±Ø§Ø¡</option>
            <option value="Other">Ø£Ø®Ø±Ù‰ (Ø¹Ø§Ù…)</option>
        </select>

        <label for="fileInput">Ø§Ø®ØªØ± Ù…Ù„Ù Ù†ØµÙŠ (.txt) ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² (ÙƒÙ„ Ø±Ø§Ø¨Ø· ÙÙŠ Ø³Ø·Ø±):</label>
        <input type="file" id="fileInput" accept=".txt" />

        <label for="manualLinks">Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙŠØ¯ÙˆÙŠÙ‹Ø§ (ÙƒÙ„ Ø±Ø§Ø¨Ø· ÙÙŠ Ø³Ø·Ø±):</label>
        <textarea id="manualLinks" placeholder="https://apps.facebook.com/family-farm/ar/facebook?xxx"></textarea>

        <button id="uploadButton" aria-label="Ø±ÙØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·">ğŸš€ Ø±ÙØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</button>
        <button id="deleteByTypeButton" class="btn-danger" aria-label="Ø­Ø°Ù Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯">ğŸ—‘ï¸ Ø­Ø°Ù Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
        <button id="deleteAllButton" class="btn-danger" aria-label="Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·">ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·</button>
        <button id="countButton" class="btn-info" aria-label="Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ ÙƒÙ„ Ù†ÙˆØ¹">ğŸ“Š Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ ÙƒÙ„ Ù†ÙˆØ¹</button>

        <div id="status" aria-live="polite" role="status"></div>
    </section>

    <!-- ØªØ¨ÙˆÙŠØ¨ ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø± -->
    <section id="duplicatesTab" class="tab-content">
        <h2>ğŸ“‹ ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙˆØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±</h2>
        <button id="checkDuplicatesBtn" class="btn-info" aria-label="ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±">ğŸ” ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±</button>
        <button id="downloadUniqueBtn" class="btn-info" aria-label="ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±</button>
        <div id="dupStatus" aria-live="polite" role="status"></div>
    </section>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://wuauxagghhzqrxgotcqo.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1YXV4YWdnaGh6cXJ4Z290Y3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0NjU3NzYsImV4cCI6MjA2ODA0MTc3Nn0.W7Ayyfdh3qmrfzw_F5t35umQZRIdmqKENNdk3HYcNVE';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const linkTypes = {
    'Super Fertilizer': 'Ø³Ù…Ø§Ø¯ Ø®Ø§Ø±Ù‚',
    'Super Watering Can': 'Ø¯Ù„Ùˆ Ø³Ù‚Ø§ÙŠØ© Ø®Ø§Ø±Ù‚',
    'Bingo': 'Ø¨ÙŠÙ†Ø¬Ùˆ',
    'normalfert': '125 Ø³Ù…Ø§Ø¯ Ø·Ø¨ÙŠØ¹ÙŠ',
    'Energy': 'Ø·Ø§Ù‚Ø©',
    'Energy2': '2 Ø·Ø§Ù‚Ø©',
    'Yellow Package': 'Ø­Ø²Ù…Ø© ØµÙØ±Ø§Ø¡',
    'Green Package': 'Ø­Ø²Ù…Ø© Ø®Ø¶Ø±Ø§Ø¡',
    'Yellow Coupons': 'Ù‚Ø³Ø§Ø¦Ù… ØµÙØ±Ø§Ø¡',
    'Purple Coupons': 'Ù‚Ø³Ø§Ø¦Ù… Ø£Ø±Ø¬ÙˆØ§Ù†ÙŠØ©',
    'Green Coupons': 'Ù‚Ø³Ø§Ø¦Ù… Ø®Ø¶Ø±Ø§Ø¡',
    'Other': 'Ø£Ø®Ø±Ù‰ (Ø¹Ø§Ù…)'
};

// --- Ø¹Ù†Ø§ØµØ± DOM ---
const linkTypeSelect = document.getElementById('linkTypeSelect');
const fileInput = document.getElementById('fileInput');
const manualLinks = document.getElementById('manualLinks');
const uploadButton = document.getElementById('uploadButton');
const deleteByTypeButton = document.getElementById('deleteByTypeButton');
const deleteAllButton = document.getElementById('deleteAllButton');
const countButton = document.getElementById('countButton');
const status = document.getElementById('status');

const checkDuplicatesBtn = document.getElementById('checkDuplicatesBtn');
const downloadUniqueBtn = document.getElementById('downloadUniqueBtn');
const dupStatus = document.getElementById('dupStatus');

const tabLinks = document.getElementById('tabLinks');
const tabDuplicates = document.getElementById('tabDuplicates');
const linksTab = document.getElementById('linksTab');
const duplicatesTab = document.getElementById('duplicatesTab');

// --- ØªØ¨ÙˆÙŠØ¨Ø§Øª ---
tabLinks.addEventListener('click', () => {
    tabLinks.classList.add('active');
    tabDuplicates.classList.remove('active');
    linksTab.classList.add('active');
    duplicatesTab.classList.remove('active');
});
tabDuplicates.addEventListener('click', () => {
    tabDuplicates.classList.add('active');
    tabLinks.classList.remove('active');
    duplicatesTab.classList.add('active');
    linksTab.classList.remove('active');
});

// --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
function updateStatus(text, type='info') {
    const colors = {
        success: ['#E8F5E9', '#2E7D32'],
        error: ['#fdecea', '#e74c3c'],
        warning: ['#FFFDE7', '#FDD835'],
        info: ['#e3f2fd', '#1e88e5']
    };
    const [bg, fg] = colors[type] || colors.info;
    status.style.backgroundColor = bg;
    status.style.color = fg;
    status.textContent = text;
}

function updateDupStatus(text, type='info') {
    const colors = {
        success: ['#E8F5E9', '#2E7D32'],
        error: ['#fdecea', '#e74c3c'],
        warning: ['#FFFDE7', '#FDD835'],
        info: ['#e3f2fd', '#1e88e5']
    };
    const [bg, fg] = colors[type] || colors.info;
    dupStatus.style.backgroundColor = bg;
    dupStatus.style.color = fg;
    dupStatus.textContent = text;
}

// --- Ø±ÙØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ---
uploadButton.addEventListener('click', async () => {
    status.textContent = '';
    let links = [];

    // Ø¬Ù„Ø¨ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù…Ù† Ø§Ù„Ù…Ù„Ù Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
    if (fileInput.files.length > 0) {
        try {
            const file = fileInput.files[0];
            const text = await file.text();
            links.push(...text.split('\n').map(l => l.trim()));
        } catch {
            updateStatus('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù!', 'error');
            return;
        }
    }
    // Ø¬Ù„Ø¨ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
    if (manualLinks.value.trim() !== '') {
        links.push(...manualLinks.value.trim().split('\n').map(l => l.trim()));
    }

    if (links.length === 0) {
        updateStatus('âŒ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙŠØ¯ÙˆÙŠÙ‹Ø§!', 'error');
        return;
    }

    // ØªØµÙÙŠØ© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµØ§Ù„Ø­Ø© ÙÙ‚Ø·
    const validLinks = links.filter(link => link.startsWith('https://apps.facebook.com/family-farm/ar/facebook'));
    const invalidCount = links.length - validLinks.length;

    if (validLinks.length === 0) {
        updateStatus('âš ï¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­Ø©! ÙŠØ¬Ø¨ Ø£Ù† ØªØ¨Ø¯Ø£ Ø¨Ù€ https://apps.facebook.com/family-farm/ar/facebook', 'warning');
        return;
    }

    updateStatus(`â³ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ${validLinks.length} Ø±Ø§Ø¨Ø·...`, 'info');

    const selectedType = linkTypeSelect.value;
    let successCount = 0;

    // Ø±ÙØ¹ ÙƒÙ„ Ø±Ø§Ø¨Ø· Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„ (ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… batch Ù„Ùˆ ØªØ­Ø¨)
    for (const link of validLinks) {
        const { error } = await supabase
            .from('reward_links')
            .insert([{ link_url: link, status: 'new', link_type: selectedType }]);
        if (!error) successCount++;
    }

    updateStatus(`âœ… ØªÙ… Ø±ÙØ¹ ${successCount} Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!${invalidCount > 0 ? ` âš ï¸ ØªÙ… ØªØ¬Ø§Ù‡Ù„ ${invalidCount} Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­.` : ''}`, 'success');
    fileInput.value = '';
    manualLinks.value = '';
});

// --- Ø­Ø°Ù Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯ ---
deleteByTypeButton.addEventListener('click', async () => {
    const selectedType = linkTypeSelect.value;
    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù†ÙˆØ¹ "${linkTypes[selectedType]}"ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹!`)) return;

    updateStatus('â³ Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ø±ÙˆØ§Ø¨Ø·...', 'info');

    const { error } = await supabase
        .from('reward_links')
        .delete()
        .eq('link_type', selectedType);

    if (error) {
        updateStatus('âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø±ÙˆØ§Ø¨Ø·!', 'error');
    } else {
        updateStatus(`âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù†ÙˆØ¹: ${linkTypes[selectedType]}`, 'success');
    }
});

// --- Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ---
deleteAllButton.addEventListener('click', async () => {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹!')) return;

    updateStatus('â³ Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·...', 'info');

    const { error } = await supabase
        .from('reward_links')
        .delete();

    if (error) {
        updateStatus('âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·!', 'error');
    } else {
        updateStatus('âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    }
});

// --- Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ ÙƒÙ„ Ù†ÙˆØ¹ ---
countButton.addEventListener('click', async () => {
    updateStatus('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ ÙƒÙ„ Ù†ÙˆØ¹...', 'info');

    try {
        let total = 0;
        let resultsHtml = '';
        for (const [key, label] of Object.entries(linkTypes)) {
            const { count, error } = await supabase
                .from('reward_links')
                .select('*', { count: 'exact', head: true })
                .eq('link_type', key);
            if (error) {
                resultsHtml += `${label}: Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¬Ù„Ø¨\n`;
            } else {
                total += count;
                resultsHtml += `${label}: ${count}\n`;
            }
        }

        resultsHtml += `\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·: ${total}`;
        updateStatus(resultsHtml, 'success');
    } catch {
        updateStatus('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨!', 'error');
    }
});

// ----------- ØªØ¨ÙˆÙŠØ¨ ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙˆØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù -----------

async function fetchAllCheckRequests() {
    let allData = [];
    let from = 0;
    const batchSize = 1000;

    while (true) {
        const { data, error } = await supabase
            .from('check_requests')
            .select('*')
            .range(from, from + batchSize - 1);

        if (error) {
            updateDupStatus('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!', 'error');
            return null;
        }
        if (!data || data.length === 0) break;

        allData = allData.concat(data);
        if (data.length < batchSize) break;

        from += batchSize;
    }
    return allData;
}

// --- ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø± ---
checkDuplicatesBtn.addEventListener('click', async () => {
    updateDupStatus('... Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ...');

    const data = await fetchAllCheckRequests();
    if (!data) {
        updateDupStatus('âŒ Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', 'error');
        return;
    }

    const totalRecords = data.length;
    const countMap = {};

    data.forEach(row => {
        if (!countMap[row.uss]) {
            countMap[row.uss] = { count: 0, names: new Set(), firstHash: row.hash };
        }
        countMap[row.uss].count++;
        countMap[row.uss].names.add(row.name);
    });

    const uniqueCount = Object.keys(countMap).length;
    const totalRepeats = totalRecords - uniqueCount;

    if (totalRepeats === 0) {
        updateDupStatus('âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙƒØ±Ø§Ø±.', 'success');
        return;
    }

    let msg = `ğŸ” Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙƒÙ„ÙŠ: ${totalRecords}\n`;
    msg += `ğŸ” Ø¹Ø¯Ø¯ Ø§Ù„Ù€ uss Ø§Ù„ÙØ±ÙŠØ¯Ø©: ${uniqueCount}\n`;
    msg += `ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ©: ${totalRepeats}\n\n`;
    for (const uss in countMap) {
        const info = countMap[uss];
        if (info.count > 1) {
            msg += `- ${[...info.names].join(', ')}: ${info.count} Ù…Ø±Ø§Øª\n`;
        }
    }
    updateDupStatus(msg, 'warning');
});

// --- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø± ---
downloadUniqueBtn.addEventListener('click', async () => {
    updateDupStatus('... Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù ...');

    const data = await fetchAllCheckRequests();
    if (!data) {
        updateDupStatus('âŒ Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', 'error');
        return;
    }

    // Ø§Ø­ØªÙØ¸ ÙÙ‚Ø· Ø¨Ø£ÙˆÙ„ Ø¸Ù‡ÙˆØ± Ù„ÙƒÙ„ uss
    const uniqueMap = {};
    for (const row of data) {
        if (!uniqueMap[row.uss]) {
            uniqueMap[row.uss] = row.hash;
        }
    }

    const lines = Object.entries(uniqueMap).map(([uss, hash]) => `${uss},${hash}`);
    const fileContent = lines.join('\n');

    // ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
    const blob = new Blob([fileContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `unique_check_requests_${new Date().toISOString().slice(0,10)}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    updateDupStatus(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ (${lines.length} Ø³Ø¬Ù„ ÙØ±ÙŠØ¯).`, 'success');
});
</script>

</body>
</html>
